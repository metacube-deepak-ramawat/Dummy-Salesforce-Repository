name: Salesforce Authentication, Test Validation & Code Coverage Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auth-and-test-salesforce:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI (@salesforce/cli)
        run: npm install --global @salesforce/cli

      - name: Install jq (JSON processor)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Write JWT Key from Secret
        run: echo "${{ secrets.SF_JWT_KEY }}" > server.key

      - name: Authenticate to Salesforce using JWT
        run: sf org login jwt \
              --client-id "${{ secrets.SF_CLIENT_ID }}" \
              --jwt-key-file server.key \
              --username "${{ secrets.SF_USERNAME }}" \
              --instance-url "${{ secrets.SF_ORG_URL }}" \
              --set-default \
              --alias my-org

      - name: Confirm authentication
        run: sf org list

      - name: Create test-results directory
        run: mkdir -p test-results

      - name: Validate deployment with tests
        run: |
          sf project deploy start \
            --dry-run \
            --wait 20 \
            --target-org my-org \
            --ignore-conflicts \
            --test-level RunLocalTests \
            --json > test-results/deploy-validation.json || true

      - name: Debug - Show deployment validation result
        run: cat test-results/deploy-validation.json

      - name: Extract, check validation result, and enforce coverage
        run: |
          deploySuccess=$(jq -r '.result.success // false' test-results/deploy-validation.json)

          if jq -e '.result.details.runTestResult' test-results/deploy-validation.json >/dev/null; then
            numFailures=$(jq '.result.details.runTestResult.numFailures // 0' test-results/deploy-validation.json)
            numTestsRun=$(jq '.result.details.runTestResult.numTestsRun // 0' test-results/deploy-validation.json)
            
            echo "Deployment validation success: $deploySuccess"
            echo "Tests run: $numTestsRun"
            echo "Test failures: $numFailures"

            # Calculate average coverage
            if jq -e '.result.details.runTestResult.codeCoverage' test-results/deploy-validation.json >/dev/null; then
              avgCoverage=$(jq '[.result.details.runTestResult.codeCoverage[] | 
                                select(.numLocations > 0) | 
                                ((.numLocationsCovered / .numLocations) * 100)] 
                                | add / length' test-results/deploy-validation.json)
              echo "ðŸ“Š Average calculated coverage: ${avgCoverage}%"
              
              coverageThreshold=30
              if (( $(echo "$avgCoverage < $coverageThreshold" | bc -l) )); then
                echo "âŒ Coverage below required threshold of ${coverageThreshold}%"
                exit 1
              fi
            fi
            
            if [ "$numFailures" -gt 0 ]; then
              echo "=== FAILED TESTS ==="
              jq '.result.details.runTestResult.failures[]' test-results/deploy-validation.json
              echo "=== END FAILED TESTS ==="
              exit 1
            fi
          else
            echo "No test results found in deployment validation"
          fi

          if [ "$deploySuccess" != "true" ]; then
            echo "âŒ Deployment validation failed"
            exit 1
          fi
          
          echo "âœ… All tests passed and deployment validation successful!"
